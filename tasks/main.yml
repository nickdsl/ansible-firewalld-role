---
- name: ensure firewalld is installed
  package:
    name: firewalld
    state: present
  tags:
    - firewalld

- name: ensure firewalld is enabled and started
  service: 
    name: firewalld
    enabled: "{{ firewalld_enabled }}"
    state: "{{ firewalld_state }}"
  tags:
    - firewalld
    - firewalld.service

- name: get actual firewalld default zone
  command: /bin/firewall-cmd --get-default-zone
  register: defaultzone
  changed_when: false
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.get.zone
    - firewalld.get.services

- name: set firewalld default zone
  command: /bin/firewall-cmd --set-default-zone={{ default_zone|default('public') }}
  register: result
  when: defaultzone.stdout != default_zone and firewalld_state != "stopped"
  changed_when: result.stdout == "success"
  tags:
    - firewalld
    - firewalld.zones

- name: set firewalld zone interfaces
  shell: |
    if [[ "$(/bin/firewall-cmd --get-zone-of-interface={{ item.1 }})" != "{{ item.0.name }}" ]]
    then
      /bin/firewall-cmd --zone={{ item.0.name }} --add-interface={{ item.1 }} --permanent && echo "changed"
    fi
  with_subelements: 
    - "{{ firewalld_zone_interfaces|default([]) }}"
    - interfaces
  register: shell_result
  changed_when: shell_result.stdout | join('') is search('changed')
  when: firewalld_state != "stopped"
  notify: restart firewalld
  tags:
    - firewalld
    - firewalld.zones

- name: set firewalld zone source
  firewalld:
    zone: "{{ item.0.zone }}"
    permanent: "{{ item.0.permanent|default('true') }}"
    immediate: "{{ item.0.immediate|default('true') }}"
    state: "{{ item.0.state|default('enabled') }}"
    source: "{{ item.1 }}"
  with_subelements:
    - "{{ firewalld_zone_source|default({}) }}"
    - "source"
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.zones

- name: get active firewalld service rules
  shell: set -o pipefail; /bin/firewall-cmd --list-services | sed -e 's/ /\n/g'
  args:
    executable: /bin/bash
  register: active_services
  changed_when: false
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.services

- name: purge unconfigured firewalld service rules
  firewalld:
    service: "{{ item }}"
    permanent: true
    immediate: true
    state: disabled
    zone: "{{ default_zone|default('public') }}"
  with_items: "{{ active_services.stdout_lines }}"
  when: firewalld_purge_services and item not in firewalld_service_rules and firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.zones
    - firewalld.service.rules


- name: get active firewalld port rules
  shell: set -o pipefail; /bin/firewall-cmd --list-ports | sed -e 's/ /\n/g'
  args:
    executable: /bin/bash
  register: active_ports
  changed_when: false
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.ports

- name: purge unconfigured firewalld port rules
  firewalld:
    port: "{{ item }}"
    permanent: true
    immediate: true
    state: disabled
    zone: "{{ default_zone|default('public') }}"
  with_items: "{{ active_ports.stdout_lines }}"
  when: firewalld_purge_services and item not in firewalld_service_rules and firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.ports

- name: set firewalld service rules
  firewalld:
    service: "{{ item.value.service | default(item.key) }}"
    permanent: "{{ item.value.permanent|default('true') }}"
    immediate: "{{ item.value.immediate|default('true') }}"
    state: "{{ item.value.state|default('enabled') }}"
    zone: "{{ item.value.zone|default('public') }}"
  with_dict: "{{ firewalld_service_rules|default({}) }}"
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.service.rules

- name: set firewalld port rules
  firewalld:
    port: "{{ item.value.port }}/{{ item.value.protocol|default('tcp') }}"
    permanent: "{{ item.value.permanent|default('true') }}"
    immediate: "{{ item.value.immediate|default('true') }}"
    state: "{{ item.value.state|default('enabled') }}"
    zone: "{{ item.value.zone|default('public') }}"
  with_dict: "{{ firewalld_port_rules|default({}) }}"
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.port.rules

- name: set firewalld rich rules
  firewalld:
    rich_rule: "{{ item.value.rule }}"
    permanent: "{{ item.value.permanent|default('true') }}"
    immediate: "{{ item.value.immediate|default('true') }}"
    state: "{{ item.value.state|default('enabled') }}"
    zone: "{{ item.value.zone|default('public') }}"
  with_dict: "{{ firewalld_rich_rules|default({}) }}"
  when: firewalld_state != "stopped"
  tags:
    - firewalld
    - firewalld.rich.rules
